---
title: "\\textbf{Rendimientos accionarios en R.}"
subtitle: "Descarga y visualización."
author: "Dr. Martín Lozano \\texttt{https://mlozanoqf.github.io/}"
date: "`r gsub('a\\. m\\.', 'a.m.', gsub('p\\. m\\.', 'p.m.', format(Sys.time(), '%d de %B de %Y, %I:%M %p')))`"
output:
  pdf_document:
    latex_engine: xelatex
    number_sections: true
    highlight: tango
header-includes:
  - \usepackage{xcolor}
  - \usepackage{fvextra}
  - |
      \DefineVerbatimEnvironment{Highlighting}{Verbatim}{
        breaklines,
        commandchars=\\\{\},
        numbers=left,
        numbersep=8pt,
        fontsize=\small,
        firstnumber=1,
        xleftmargin=1.5em,
        frame=none
      }
      % ← Estilo de los números de línea (más visibles)
      \renewcommand{\theFancyVerbLine}{\textcolor{black}{\bfseries\small\arabic{FancyVerbLine}}}
  - \usepackage{amssymb}
  - \usepackage{amsmath}
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(knitr)

tabla <- matrix(
  c("$\\checkmark$", "$\\times$", "$\\times$",
    "$\\checkmark$", "$\\times$", "$\\times$",
    "$\\times$", "$\\checkmark$", "$\\times$"),
  nrow = 3, byrow = TRUE
)
colnames(tabla) <- c("Fundamental", "Intermedio", "Especializado")
rownames(tabla) <- c("Finanzas", "Estadística", "R")

kable(tabla, escape = FALSE, align = c("c","c","c"))

```





```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  class.source = "numberLines",   # activa numeración en todos los chunks con echo=TRUE
  Sys.setlocale("LC_TIME", "es_ES.UTF-8")
)
```

\newpage
\Large 

# Introducción.

En negocios necesitamos datos para evaluar y fundamentar decisiones.

\begin{itemize}
  \item \textbf{Partimos de un propósito.} Un problema que resolver, una hipótesis que validar, un objetivo que alcanzar o una tarea que ejecutar.
  \item \textbf{Datos.} Sin información, nuestras conclusiones serían simples opiniones.
  \item \textbf{Analizamos y modelamos.} Usamos los datos para analizar, estimar o entrenar modelos que permitan un análisis empírico riguroso.
  \item \textbf{Generamos evidencia.} Los resultados nos ayudan a validar hipótesis, resolver problemas y generar nuevo conocimiento para tomar decisiones.
  \end{itemize}

\newpage
\normalsize

# Paquetes.

```{r}
  library(tidyquant)
  library(dplyr)
  library(lubridate)
  library(tidyr)
  library(ggplot2)
```

\newpage

# Descargar precios y transformar a rendimientos.

```{r}
  symbols <- c("GOOGL", "META", "WMT", "KO", "NKE")

  annual_returns <- tq_get(symbols,
                           from = "2020-01-01",
                           to   = "2024-12-31") |>
    group_by(symbol) |>
    tq_transmute(select      = adjusted,
                 mutate_fun  = periodReturn,
                 period      = "yearly",
                 type        = "arithmetic",
                 col_rename  = "annual_return") |>
    mutate(year          = year(date),
           annual_return = round(annual_return, 4)) |>
    select(-date) |>
    arrange(symbol, year)

  annual_returns
```
\newpage

# Visualizar en tabla.

```{r}
  annual_returns_wide <- annual_returns |>
    mutate(year = as.character(year)) |>
    pivot_wider(names_from = year, values_from = annual_return)

  annual_returns_wide
```

\newpage

# Datos en sección cruzada.

```{r}
  annual_returns |>
    filter(year == 2024) |>
    mutate(direction = if_else(annual_return >= 0, 
                               "positive", "negative")) |>
    ggplot(aes(x = symbol, 
               y = annual_return, fill = direction)) +
    geom_col(width = 0.7) +
    geom_hline(yintercept = 0) +
    scale_fill_manual(values = c(positive = "blue", 
                                 negative = "red")) +
    scale_y_continuous(labels = 
                      scales::percent_format(accuracy = 1)) +
    labs(title = "Rendimiento anual por empresa en el 2024.",
         x = "Símbolo",
         y = "Rendimiento") +
    theme_minimal() +
    theme(legend.position = "none")
```
\newpage

# Datos en serie de tiempo.

```{r}
annual_returns |>
    ungroup() |>
    filter(symbol == "GOOGL") |>
    mutate(direction = if_else(annual_return >= 0, 
                               "positive", "negative")) |>
    ggplot(aes(x = factor(year), 
               y = annual_return, fill = direction)) +
    geom_hline(yintercept = 0) +
    geom_col(width = 0.6) +
    scale_fill_manual(values = c(positive = "blue", 
                                 negative = "red")) +
    scale_y_continuous(labels = 
                      scales::percent_format(accuracy = 1),
                      expand = expansion(mult = c(0.05, 0.15))) +
    labs(title = "Rendimiento anual de GOOGL.",
         x = "Año",
         y = "Rendimiento") +
    theme_minimal() +
    theme(legend.position = "none")
```

\newpage

# Datos de panel.

```{r}
legend_order <- annual_returns |>
    filter(year == 2024) |>
    arrange(desc(annual_return)) |>
    pull(symbol)

  annual_returns |>
    ungroup() |>
    mutate(symbol = factor(symbol, levels = legend_order)) |>
    ggplot(aes(x = year, y = annual_return, color = symbol)) +
    geom_line(linewidth = 1.1) +
    geom_point(size = 2.2) +
    scale_color_brewer(palette = "Set1") +
    scale_x_continuous(breaks = seq(2020, 2024, by = 1)) +
    scale_y_continuous(labels = 
                      scales::percent_format(accuracy = 1),
                      expand = expansion(mult = c(0.05, 0.15))) +
    labs(title = "Evolución del rendimiento anual por empresa.",
         x = "Año",
         y = "Rendimiento",
         color = "Símbolo") +
    theme_minimal()
```

\newpage

# Datos de panel visualización alternativa.

```{r}
annual_returns |> 
  ggplot(aes(x = year, y = symbol, fill = annual_return)) + 
  geom_tile(color = "white") + 
  scale_fill_viridis_c(option = "C",
                begin = 0.1, end = 0.9, 
                labels = 
                scales::percent_format(accuracy = 1)) + 
  labs(title = "Rendimiento anual por empresa", 
       x = "Año", 
        y = "Empresa", fill = "Rendimiento" ) + 
  theme_minimal()
```

\newpage

# Rendimientos acumulados.

```{r}
cumulative_returns <- annual_returns |>
    ungroup() |>
    arrange(symbol, year) |>
    group_by(symbol) |>
    mutate(cum_value = cumprod(1 + annual_return)) |>
    ungroup() |>
    mutate(symbol = factor(symbol, levels = legend_order))

  legend_order_cum <- cumulative_returns |>
    filter(year == max(year)) |>
    arrange(desc(cum_value)) |>
    pull(symbol)

  cumulative_with_start <- cumulative_returns |>
    mutate(symbol = factor(symbol, levels = legend_order_cum)) |>
    select(symbol, year, cum_value) |>
    bind_rows(
      annual_returns |>
        distinct(symbol) |>
        mutate(year = 2019, cum_value = 1,
               symbol = factor(symbol, levels =
                                 legend_order_cum))) |>
    arrange(symbol, year)
  
cumulative_with_start
```


\newpage

```{r}
cumulative_with_start |>
    ggplot(aes(x = year, y = cum_value, color = symbol)) +
    geom_line(linewidth = 1.1) +
    geom_point(size = 2.2) +
    scale_color_brewer(palette = "Set1") +
    scale_x_continuous(breaks = c(2019, seq(2020, 2024)),
                       labels = c("t=0", 2020:2024)) +
    scale_y_continuous(labels = 
                         scales::dollar_format(accuracy = 1), 
                       expand = 
                         expansion(mult = c(0.05, 0.15))) +
    labs(title = "Evolución de una inversión de $1.",
         x = "Año",
         y = "Valor acumulado",
         color = "Símbolo") +
    theme_minimal()
```
\newpage

# Rendimientos acumulados visualización alternativa.

```{r}
initial_point <- annual_returns |>
    distinct(symbol) |>
    mutate(year = 2019,
           cum_value = 1,
           symbol = factor(symbol, levels = legend_order_cum))

  cumulative_facets <- cumulative_returns |>
    mutate(symbol = factor(symbol, levels = legend_order_cum)) |>
    select(symbol, year, cum_value) |>
    bind_rows(initial_point) |>
    arrange(symbol, year) |>
    mutate(year = factor(year, levels = c(2019, 2020:2024),
                         labels = c("t=0", 2020:2024)))
  
cumulative_facets
```

\newpage

```{r}
cumulative_facets |>
    ggplot(aes(x = year, y = cum_value)) +
    geom_col(width = 0.65, fill = "blue", color = NA) +
    geom_text(aes(label = 
                    scales::dollar(cum_value, accuracy = 0.01)), 
              vjust = -0.4, size = 3) + 
  scale_y_continuous(labels = 
                       scales::dollar_format(accuracy = 1),
                       expand = 
                       expansion(mult = c(0.05, 0.20))) +
    facet_wrap(~ symbol, ncol = 3) +
    labs(title = "Valor acumulado de una inversión de $1.",
         x = NULL,
         y = "Valor acumulado") +
    theme_minimal(base_size = 11) +
    theme(panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.border = 
            element_rect(color = "gray", fill = NA, 
                         linewidth = 0.6),
          strip.text = element_text(face = "bold"),
          legend.position = "none")
```
\newpage

# Conclusión.

\Large 

En negocios necesitamos datos para evaluar y fundamentar decisiones.

\begin{itemize}
  \item R facilita el análisis financiero reproducible al integrar en un solo flujo la descarga, transformación y visualización de datos con paquetes como \texttt{tidyquant},
  \texttt{dplyr} y \texttt{ggplot2}.
  \item Este enfoque promueve decisiones financieras mejor fundamentadas.
  \end{itemize}

\newpage
\normalsize

